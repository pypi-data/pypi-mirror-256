var yafowil_color=function(e,t){"use strict";class i{constructor(e,i,s,o=!1,l=!1){this.widget=e,this.container=i,this.color=s,this.locked=l,this.selected=!1,this.kelvin=o,this.destroy=this.destroy.bind(this),o&&!this.widget.type_kelvin||this.widget.type_kelvin&&!o||!this.widget.type_alpha&&s.alpha<1||o&&this.widget.type_kelvin&&(s.kelvin<this.widget.min||s.kelvin>this.widget.max)?this.invalid=!0:(this.elem=t("<div />").addClass("color-swatch layer-transparent").appendTo(this.container),this.color_layer=t("<div />").addClass("layer-color").css("background-color",this.color.rgbaString).appendTo(this.elem),l&&this.elem.addClass("locked").append(t('<div class="swatch-mark" />')),this.widget.color_equals(s)&&(this.selected=!0),this.select=this.select.bind(this),this.elem.on("click",this.select))}get selected(){return this._selected}set selected(e){e?(t("div.color-swatch",this.widget.dropdown_elem).removeClass("selected"),this.elem.addClass("selected"),this.widget.picker.color.set(this.color)):this.elem&&this.elem.removeClass("selected"),this._selected=e}destroy(){this.widget.active_swatch=null,this.locked||this.invalid||(this.elem.off("click",this.select),this.elem.remove())}select(e){if(this.widget.active_swatch!==this){let e=this.widget.picker.color.clone();this.previous_color=e.rgbaString,this.widget.active_swatch=this}else this.widget.active_swatch==this&&(this.widget.active_swatch=null,this.selected=!1,this.widget.picker.color.set(this.previous_color))}}class s{constructor(e,i=[]){this.widget=e,this.elem=t("<div />").addClass("color-picker-recent").appendTo(e.dropdown_elem),this.swatches=[],this.init_swatches(i)}parse_swatch(e){let t,i=!1,s="string"==typeof e||"object"==typeof e;if(e instanceof Array)t={r:e[0],g:e[1],b:e[2]},e[3]&&(t.a=e[3]);else if("string"==typeof(o=e)&&!o.startsWith("#")&&parseInt(o)==o||"number"==typeof o)t=iro.Color.kelvinToRgb(e.toString()),i=!0;else{if(!s)return void console.log(`ERROR: not supported color format at ${e}`);t=e}var o;return{color:new iro.Color(t),kelvin:i}}init_swatches(e){if(e&&e.length)for(let t of e){let e=this.parse_swatch(t);this.swatches.push(new i(this.widget,this.elem,e.color,e.kelvin,!0)),this.elem.show()}else this.elem.hide()}}class o{constructor(e){this.widget=e,this.elem=t("<div />").addClass("color-picker-recent").appendTo(e.dropdown_elem),this.add_color_btn=t("<button />").addClass("add_color").text("+ Add"),this.remove_color_btn=t("<button />").addClass("remove_color").text("- Remove").hide(),this.buttons=t("<div />").addClass("buttons").append(this.add_color_btn).append(this.remove_color_btn).appendTo(e.dropdown_elem),this.swatches=[],this.init_swatches(),this.create_swatch=this.create_swatch.bind(this),this.add_color_btn.on("click",this.create_swatch),this.remove_swatch=this.remove_swatch.bind(this),this.remove_color_btn.on("click",this.remove_swatch),this.init_swatches=this.init_swatches.bind(this),e.elem.on("yafowil-color-swatches:changed",this.init_swatches)}init_swatches(e){let t=localStorage.getItem("yafowil-color-swatches");for(let e of this.swatches)e.destroy();if(this.swatches=[],t){this.elem.show(),this.remove_color_btn.show();let e=JSON.parse(t);for(let t of e){let e=new iro.Color(t.color);this.swatches.push(new i(this.widget,this.elem,e,t.kelvin))}this.swatches.length>10&&(this.swatches[0].destroy(),this.swatches.shift())}else this.remove_color_btn.hide()}create_swatch(e){if(e&&"click"===e.type&&e.preventDefault(),this.widget.locked_swatches)for(let e of this.widget.locked_swatches.swatches)if(this.widget.color_equals(e.color))return;for(let e of this.swatches)if(this.widget.color_equals(e.color))return;let t=new i(this.widget,this.elem,this.widget.picker.color.clone(),this.widget.type_kelvin);this.swatches.push(t),this.set_swatches()}remove_swatch(e){if(e&&"click"===e.type&&e.preventDefault(),!this.widget.active_swatch||this.widget.active_swatch.locked)return;let t=this.swatches.indexOf(this.widget.active_swatch);this.widget.active_swatch.destroy(),this.swatches.splice(t,1),this.swatches.length||(this.elem.hide(),this.remove_color_btn.hide(),this.widget.picker.color.reset()),this.elem.hide(),this.remove_color_btn.hide(),this.widget.picker.color.reset(),this.set_swatches()}set_swatches(){let e=[];for(let t of this.swatches)e.push({color:t.color.hsva,kelvin:t.kelvin});e.length?localStorage.setItem("yafowil-color-swatches",JSON.stringify(e)):localStorage.removeItem("yafowil-color-swatches");let i=new t.Event("yafowil-color-swatches:changed",{origin:this});t("input.color-picker").trigger(i)}}class l{constructor(e,t,i,s,o={min:1e3,max:4e4}){this.widget=e,this.elem=t,this.elem.attr("spellcheck","false"),this.elem.addClass("form-control"),this.format=s||"hexString","hexString"===this.format?this.elem.attr("maxlength",7):"hex8String"===this.format&&this.elem.attr("maxlength",9),this.temperature=o,this.color=i,this.color&&this.update_color(i),this.on_input=this.on_input.bind(this),this.elem.on("input",this.on_input),this.on_focusout=this.on_focusout.bind(this),this.elem.on("focusout",this.on_focusout),this.update_color=this.update_color.bind(this)}on_input(e){let t=this.elem.val();this._color=t}on_focusout(){let e=this._color;e&&("kelvin"===this.format?(parseInt(e)<this.temperature.min?e=this.temperature.min:parseInt(e)>this.temperature.max&&(e=this.temperature.max),this.widget.color_picker.picker.color.kelvin=e,this.elem.val(e)):this.widget.color_picker.picker.color.set(e),this._color=null)}update_color(e){"kelvin"===this.format?this.elem.val(e.kelvin):this.elem.val(e[this.format])}}class r{constructor(e,i,s){this.widget=e,this.layer=t("<div />").addClass("layer-color"),this.elem=i.addClass("layer-transparent").append(this.layer).insertAfter(this.widget.elem),this.color=s?s.rgbaString:void 0,this.on_click=this.on_click.bind(this),this.elem.on("click",this.on_click)}get color(){return this._color}set color(e){this.layer.css("background-color",e),this._color=e}on_click(){this.widget.open()}}const h={box:"box",wheel:"wheel",r:"red",g:"green",b:"blue",a:"alpha",h:"hue",s:"saturation",v:"value",k:"kelvin"};function c(e){if(!e)return null;let t,i=e.split("."),s=window;for(const e in i){if(t=i[e],void 0===s[t])throw"'"+t+"' not found.";s=s[t]}return s}class a{constructor(e,i){this.elem=e,i.on_open&&this.elem.on("color_open",i.on_open),i.on_update&&this.elem.on("color_update",i.on_update),i.on_close&&this.elem.on("color_close",i.on_close),this.dropdown_elem=t("<div />").addClass("color-picker-wrapper").css("top",this.elem.outerHeight()).insertAfter(this.elem),this.picker_container=t("<div />").addClass("color-picker-container").appendTo(this.dropdown_elem),this.close_btn=t("<button />").addClass("close-button").text("âœ•").appendTo(this.dropdown_elem),this.slider_size=i.slider_size;let l=this.init_opts(i);this.picker=new iro.ColorPicker(this.picker_container.get(0),l);let h=i.sliders;h&&h.includes("box")&&h.includes("wheel")?(h.indexOf("box")<h.indexOf("wheel")?t("div.IroWheel",this.picker_container).hide():t("div.IroBox",this.picker_container).hide(),this.switch_btn=t("<button />").addClass("iro-switch-toggle").append(t('<i class="glyphicon glyphicon-refresh" />')).appendTo(this.dropdown_elem),this.switch_btn.on("click",(e=>{e.preventDefault(),t("div.IroWheel",this.picker_container).toggle(),t("div.IroBox",this.picker_container).toggle()}))):h||this.picker_container.hide(),this.type_kelvin="kelvin"===i.format,this.type_kelvin&&(this.min=i.temperature.min,this.max=i.temperature.max);let c;if(this.type_alpha=["rgbaString","hex8String","hslaString"].includes(i.format),i.locked_swatches||i.user_swatches||this.picker_container.css("margin-bottom",0),i.color?this.color=this.picker.color.clone():this.color=null,i.locked_swatches&&(this.locked_swatches=new s(this,i.locked_swatches)),i.user_swatches&&(this.user_swatches=new o(this)),i.preview_elem)c=t(i.preview_elem).addClass("yafowil-color-picker-preview");else{let e=this.elem.outerWidth();c=t("<span />").addClass("yafowil-color-picker-color layer-transparent").css("left",`${e}px`)}this.preview=new r(this,c,this.color),this.open=this.open.bind(this),this.update_color=this.update_color.bind(this),this.picker.on("color:change",this.update_color),this.close=this.close.bind(this),this.close_btn.on("click",this.close),this.on_keydown=this.on_keydown.bind(this),this.on_click=this.on_click.bind(this)}get active_swatch(){return this._active_swatch}set active_swatch(e){e?(e.selected=!0,this._active_swatch=e):this._active_swatch=null}init_opts(e){let t={width:e.box_width,boxHeight:e.box_height||e.box_width,layoutDirection:e.layout_direction||"vertical",layout:[]};"kelvin"===e.format?t.color=iro.Color.kelvinToRgb(e.color):t.color=e.color?e.color:"#fff";return(e.sliders||[]).forEach((i=>{let s=h[i];"box"===s?t.layout.push({component:iro.ui.Box,options:{}}):"wheel"===s?t.layout.push({component:iro.ui.Wheel,options:{}}):t.layout.push({component:iro.ui.Slider,options:{sliderType:s,sliderSize:e.slider_size,sliderLength:e.slider_length,minTemperature:e.temperature?e.temperature.min:void 0,maxTemperature:e.temperature?e.temperature.max:void 0,disabled:e.disabled,showInput:e.show_inputs,showLabel:e.show_labels}})})),t}update_color(){this.color=this.picker.color.clone(),this.preview.color=this.color.rgbaString;let e=new t.Event("color_update",{origin:this});this.elem.trigger(e)}open(e){"none"===this.dropdown_elem.css("display")?(this.dropdown_elem.show(),t(window).on("keydown",this.on_keydown),t(window).on("mousedown",this.on_click)):this.close(),this.elem.trigger(new t.Event("color_open",{origin:this}))}on_keydown(e){if("Enter"===e.key||"Escape"===e.key)e.preventDefault(),this.close();else if("Delete"===e.key)e.preventDefault(),this.user_swatches&&this.user_swatches.remove_swatch();else if("ArrowLeft"===e.key||"ArrowRight"===e.key){if(!this.locked_swatches&&!this.user_swatches||!this.active_swatch)return;let t,i,s=this.active_swatch,o=Boolean(this.user_swatches),l=Boolean(this.locked_swatches);o&&(t=this.user_swatches.swatches.filter((e=>!e.invalid))),l&&(i=this.locked_swatches.swatches.filter((e=>!e.invalid)));const r=s.locked?i:t;let h=r.indexOf(s);h="ArrowLeft"===e.key?h-1:h+1,h<0?!s.locked&&l&&i.length&&(this.active_swatch=i[i.length-1]):h>=r.length?s.locked&&o&&t.length&&(this.active_swatch=t[0]):this.active_swatch=r[h]}}on_click(e){let t=this.dropdown_elem;t.is(e.target)||0!==t.has(e.target).length||this.preview.elem.is(e.target)||"block"!==t.css("display")||this.close()}close(e){e&&e.preventDefault(),this.dropdown_elem.hide(),t(window).off("keydown",this.on_keydown),t(window).off("mousedown",this.on_click);let i=new t.Event("color_close",{origin:this});this.elem.trigger(i)}color_equals(e){if(this.color&&e instanceof iro.Color&&e.hsva.h===this.color.hsva.h&&e.hsva.s===this.color.hsva.s&&e.hsva.v===this.color.hsva.v&&e.hsva.a===this.color.hsva.a)return!0}}class n{static initialize(e){t("input.color-picker",e).each((function(){let e=t(this);if(void 0!==window.yafowil_array&&window.yafowil_array.inside_template(e))return;let i={format:e.data("format"),preview_elem:e.data("preview_elem"),sliders:e.data("sliders"),box_width:e.data("box_width"),box_height:e.data("box_height"),slider_size:e.data("slider_size"),color:e.val(),locked_swatches:e.data("locked_swatches"),user_swatches:e.data("user_swatches"),temperature:e.data("temperature"),disabled:e.data("disabled"),show_inputs:e.data("show_inputs"),show_labels:e.data("show_labels"),slider_length:e.data("slider_length"),layout_direction:e.data("layout_direction"),open_on_focus:e.data("open_on_focus"),on_open:c(e.data("on_open")),on_update:c(e.data("on_update")),on_close:c(e.data("on_close"))};new n(e,i)}))}constructor(e,t){e.data("yafowil-color",this),this.elem=e,this.color_picker=new a(e,t),this.temp=t.temperature||{min:2e3,max:11e3},this.input_elem=new l(this,this.elem,this.color_picker.color,t.format,this.temp),t.open_on_focus&&this.elem.on("focus",this.color_picker.open),this.elem.on("color_update",(e=>{this.input_elem.update_color(this.color_picker.color)})),this.elem.on("color_close",(e=>{this.elem.blur()}))}}function d(e,t){n.initialize(t)}function w(){void 0!==window.yafowil_array&&window.yafowil_array.on_array_event("on_add",d)}return t((function(){void 0!==window.ts?ts.ajax.register(n.initialize,!0):void 0!==window.bdajax?bdajax.register(n.initialize,!0):n.initialize(),w()})),e.ColorPicker=a,e.ColorWidget=n,e.lookup_callback=c,e.register_array_subscribers=w,Object.defineProperty(e,"__esModule",{value:!0}),window.yafowil=window.yafowil||{},window.yafowil.color=e,e}({},jQuery);
