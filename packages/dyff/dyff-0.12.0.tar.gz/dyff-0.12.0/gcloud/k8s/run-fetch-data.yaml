# Copyright UL Research Institutes
# SPDX-License-Identifier: Apache-2.0

apiVersion: "batch/v1"
kind: "Job"
metadata:
  name: "fetch-data"
spec:
  template:
    spec:
      containers:
        - name: run
          image: "us-central1-docker.pkg.dev/dyff-354017/dyff-system/alignmentlabs/dyff/fetch-data:latest"
          args:
            - "--source=https://zenodo.org/api/records/3239543"
            - "--source_kind=zenodo"
            - "--upload_bucket=alignmentlabs-rawdata-14a802b4b854421f"
      initContainers:
        - name: init-workload-identity
          image: "us-central1-docker.pkg.dev/dyff-354017/dyff-system/alignmentlabs/dyff/fetch-data:latest"
          command: ["/bin/bash", "-c"]
          args:
            - >-
              curl -sS -H 'Metadata-Flavor: Google'
              'http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token'
              --retry 30 --retry-connrefused --retry-max-time 60 --connect-timeout 3 --fail --retry-all-errors
              > /dev/null && exit 0 || echo 'Failed to wait for GKE metadata server.' >&2; exit 1
      serviceAccountName: data-fetcher
      restartPolicy: Never
  backoffLimit: 4
