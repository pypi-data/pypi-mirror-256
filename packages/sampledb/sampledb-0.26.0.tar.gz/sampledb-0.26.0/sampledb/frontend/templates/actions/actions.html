{% extends "base.html" %}

{% block title %} {{ _('Actions') }} — {{ service_name }}{% endblock %}

{% block content %}
  <h1>{% if action_type %}{{ _('%(action_type)s Actions', action_type=action_type.name | get_translated_text(default=_('Unnamed Action Type'))) }} {% else %}{{ _('Actions') }}{% endif %}</h1>
  <p class="text-muted">{% if action_type and action_type.description %}{{ action_type.description | get_translated_text(default='—') }}{% else %}{{ _('Actions represent processes like creating a sample or performing a measurement.') }}{% endif %} <a href="https://scientific-it-systems.iffgit.fz-juelich.de/SampleDB/user_guide/actions.html">{{ _("Read more.") }}</a></p>
  {% if (current_user.is_admin or user_is_instrument_scientist) and not current_user.is_readonly and (not action_type or not action_type.admin_only or current_user.is_admin) %}
    {% if action_type %}
    <a href="{{ url_for('.new_action', action_type_id=action_type.id) }}" class="btn btn-default">{{ _("Create Action") }} </a>
    {% else %}
    <a href="{{ url_for('.new_action') }}" class="btn btn-default">{{ _("Create Action") }}</a>
    {% endif %}
  {% endif %}
  {% for action in actions %}
    <form action="{{ url_for('.toggle_favorite_action', object_id=request.args.getlist('object_id'), t=request.args.get('t', None)) }}" method="post">
      <input type="hidden" name="action_id" value="{{ action.id }}">
      {{ toggle_favorite_action_form.csrf_token() }}
      <h2>
        {% if action.user is not none %}
          {% set action_owner = get_user(action.user_id) %}
          {% set federated_user, imported_user = get_federated_identity(action_owner) %}
          <a href="{{ url_for('.user_profile', user_id=federated_user.id) }}" title="{{ federated_user.get_name() }}">{{ federated_user.get_name() }}</a>
          {% if imported_user is not none %}
            {{ import_information_symbol(imported_user) }} /
          {% else %}
            {{ import_information_symbol(action_owner) }} /
          {% endif %}
        {% endif %}
        {% if action.instrument is not none and not config['DISABLE_INSTRUMENTS'] %}
          <a href="{{ url_for('.instrument', instrument_id=action.instrument.id) }}" title="{{ action.instrument.name | get_translated_text(default=_('Unnamed Instrument')) }}">{{ action.instrument.name | get_translated_text(default=_('Unnamed Instrument')) }}</a>
          {{ import_information_symbol(action.instrument) }} &mdash;
        {% endif %}
        <a href="{{ url_for('.action', action_id=action.id, object_id=request.args.getlist('object_id')) }}" title="{{ action.name | get_translated_text(default=_('Unnamed Action')) }}">{{ action.name | get_translated_text(default=_('Unnamed Action')) }}</a>
        {{ import_information_symbol(action) }}
        <button type="submit" class="fa {% if action.id in user_favorite_action_ids %}fav-star-on{% else %}fav-star-off{% endif %}" value=""></button>
      </h2>
    </form>
    {% if action.is_hidden %}
    <p class="text-muted"><i class="fa fa-eye-slash" aria-hidden="true"></i> {{ _("This action has been hidden from action lists.") }} </p>
    {% endif %}

    {% if action.short_description | get_translated_text %}
      <div class="action-user-content">
        {% if action.short_description_is_markdown %}{{ action.short_description | get_translated_text | markdown_to_safe_html(anchor_prefix='action-short-description') | safe }}{% else %}<p>{{ action.short_description | get_translated_text }}</p>{% endif %}
      </div>
    {% endif %}
    {% if not config['DISABLE_INSTRUMENTS'] %}
    {% with instrument = action.instrument %}
      {% include "instruments/instrument_scientists.html" %}
    {% endwith %}
    {% endif %}
    {% if action.type_id is none or not action.type.disable_create_objects %}
    <p>
      <a href="{{ url_for('.objects', action_ids=action.id) }}" class="btn btn-default">{{ action.type.view_text | get_translated_text(default=_('View Objects')) if action.type_id else _('View Objects') }}</a>
      {% if not current_user.is_readonly and action.type_id is not none and action.schema is not none and (not action.disable_create_objects) and (not action.admin_only or current_user.is_admin) %}
      <a href="{{ url_for('.new_object', action_id=action.id, object_id=request.args.getlist('object_id')) }}" class="btn btn-primary">{{ action.type.perform_text | get_translated_text(default=_('Create Object')) if action.type_id else _('Create Object') }}</a>
      {% endif %}
    </p>
    {% endif %}
  {% endfor %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ fingerprinted_static('sampledb/js/markdown_image_viewer.js') }}" type="module"></script>
{% endblock %}
