services:
  missim_core:
    container_name: missim_core
    image: ghcr.io/greenroom-robotics/missim_core
    build:
      context: ./
      dockerfile: projects/missim_core/Dockerfile
      secrets:
        - apt_conf
        - API_TOKEN_GITHUB
    volumes:
      - /dev/shm:/dev/shm
      - ./projects/missim_core/src:/home/ros/missim_core/src
      - ./projects/missim_core/ros-ts-generator-config.json:/home/ros/missim_core/ros-ts-generator-config.json
      - ./projects/missim_ui/src/generated/ros:/home/ros/missim_core/generated/ros
      - ./projects/missim_ui/certs:/home/ros/missim_core/certs
      - ./packages/missim_interfaces:/home/ros/missim_core/src/missim_interfaces
      - ./packages/missim_scenarios:/home/ros/missim_core/src/missim_scenarios
      - ./packages/vessel_dynamics:/home/ros/missim_core/src/vessel_dynamics
      - ./packages/missim_vessel:/home/ros/missim_core/src/missim_vessel
      - ~/.config/greenroom:/home/ros/.config/greenroom
    command: platform ros launch missim_bringup missim.launch.py --build --watch
    environment:
      ROS_DOMAIN_ID: ${ROS_DOMAIN_ID}

  missim_ui:
    container_name: missim_ui
    image: ghcr.io/greenroom-robotics/missim_ui:latest
    build:
      context: ./projects/missim_ui
      secrets:
        - API_TOKEN_GITHUB
    volumes:
      - /dev/shm:/dev/shm
      - ./projects/missim_ui/.eslintrc.js:/app/.eslintrc.js
      - ./projects/missim_ui/.nvmrc:/app/.nvmrc
      - ./projects/missim_ui/.yarnrc:/app/.yarnrc
      - ./projects/missim_ui/index.html:/app/index.html
      - ./projects/missim_ui/package.json:/app/package.json
      - ./projects/missim_ui/public:/app/public
      - ./projects/missim_ui/src:/app/src
      - ./projects/missim_ui/tsconfig.json:/app/tsconfig.json
      - ./projects/missim_ui/typings:/app/typings
      - ./projects/missim_ui/vite.config.ts:/app/vite.config.ts
      - ./projects/missim_ui/certs:/app/certs
    environment:
      USE_HTTPS: ${USE_HTTPS:-false}
    command: yarn dev

  missim_chart_tiler:
    container_name: missim_chart_tiler
    image: ghcr.io/greenroom-robotics/gr_chart_tiler:1.1.0
    ports:
      - 5003:8080
    volumes:
      - ./projects/missim_chart_tiler/styles:/app/data/styles
      - ./projects/missim_chart_tiler/tiles:/app/data/tiles
      - ./projects/missim_chart_tiler/config.json:/app/data/config.json

secrets:
  API_TOKEN_GITHUB:
    file: ./.secrets/API_TOKEN_GITHUB
  apt_conf:
    file: ./.secrets/apt.conf
