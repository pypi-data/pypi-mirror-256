

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pytomography.projectors.PET.petlm_system_matrix &#8212; PyTomography 1.3.2 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pytomography/projectors/PET/petlm_system_matrix';</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../../../_static/PT1.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../../_static/PT1.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../usage.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../developers_guide.html">
                        Developer’s Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../external_data.html">
                        External Data
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../autoapi/index.html">
                        API Reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../usage.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../developers_guide.html">
                        Developer’s Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../external_data.html">
                        External Data
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../autoapi/index.html">
                        API Reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../../pytomography.html" class="nav-link">pytomography</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">pytomography.projectors.PET.petlm_system_matrix</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for pytomography.projectors.PET.petlm_system_matrix</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">pytomography</span>
<span class="kn">from</span> <span class="nn">pytomography.transforms</span> <span class="kn">import</span> <span class="n">Transform</span>
<span class="kn">from</span> <span class="nn">pytomography.metadata</span> <span class="kn">import</span> <span class="n">ObjectMeta</span><span class="p">,</span> <span class="n">PETLMProjMeta</span>
<span class="kn">from</span> <span class="nn">pytomography.projectors</span> <span class="kn">import</span> <span class="n">SystemMatrix</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">parallelproj</span>
<div class="viewcode-block" id="PETLMSystemMatrix"><a class="viewcode-back" href="../../../../autoapi/pytomography/projectors/PET/petlm_system_matrix/index.html#pytomography.projectors.PET.PETLMSystemMatrix">[docs]</a><span class="k">class</span> <span class="nc">PETLMSystemMatrix</span><span class="p">(</span><span class="n">SystemMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;System matrix of PET list mode data. Forward projections corresponds to computing the expected counts along all LORs specified: in particular it approximates :math:`g_i = \int_{\text{LOR}_i} h(r) f(r) dr` where index :math:`i` corresponds to a particular detector pair and :math:`h(r)` is a Gaussian function that incorporates time-of-flight information (:math:`h(r)=1` for non-time-of-flight). The integral is approximated in the discrete object space using Joseph3D projections. In general, the system matrix implements two different projections, the quantity :math:`H` which projects to LORs corresponding to all detected events, and the quantity :math:`\tilde{H}` which projects to all valid LORs. The quantity :math:`H` is used for standard forward/back projection, while :math:`\tilde{H}` is used to compute the sensitivity image.</span>

<span class="sd">        Args:</span>
<span class="sd">            object_meta (SPECTObjectMeta): Metadata of object space, containing information on voxel size and dimensions.</span>
<span class="sd">            proj_meta (PETLMProjMeta): PET listmode projection space metadata. This information contains the detector ID pairs of all detected events, as well as a scanner lookup table and time-of-flight metadata. In addition, this meadata contains all information regarding event weights, typically corresponding to the effects of attenuation :math:`\mu` and :math:`\eta`. </span>
<span class="sd">            obj2obj_transforms (Sequence[Transform]): Object to object space transforms applied before forward projection and after back projection. These are typically used for PSF modeling in PET imaging.</span>
<span class="sd">            attenuation_map (torch.tensor[float] | None, optional): Attenuation map used for attenuation modeling. If provided, all weights will be scaled by detection probabilities derived from this map. Note that this scales on top of any weights provided in ``proj_meta``, so if attenuation is already accounted for there, this is not needed. Defaults to None.</span>
<span class="sd">            N_splits (int): Splits up computation of forward/back projection to save GPU memory. Defaults to 1.</span>
<span class="sd">            device (str): The device on which forward/back projection tensors are output. This is seperate from ``pytomography.device``, which handles internal computations. The reason for having the option of a second device is that the projection space may be very large, and certain GPUs may not have enough memory to store the projections. If ``device`` is not the same as ``pytomography.device``, then one must also specify the same ``device`` in any reconstruction algorithm used. Defaults to ``pytomography.device``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">object_meta</span><span class="p">:</span> <span class="n">ObjectMeta</span><span class="p">,</span>
        <span class="n">proj_meta</span><span class="p">:</span> <span class="n">PETLMProjMeta</span><span class="p">,</span>
        <span class="n">obj2obj_transforms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Transform</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">attenuation_map</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">N_splits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PETLMSystemMatrix</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">obj2obj_transforms</span><span class="o">=</span><span class="n">obj2obj_transforms</span><span class="p">,</span>
            <span class="n">proj2proj_transforms</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">object_meta</span><span class="o">=</span><span class="n">object_meta</span><span class="p">,</span>
            <span class="n">proj_meta</span><span class="o">=</span><span class="n">proj_meta</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TOF</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TOF</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_origin</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">object_meta</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">object_meta</span><span class="o">.</span><span class="n">dr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj2obj_transforms</span> <span class="o">=</span> <span class="n">obj2obj_transforms</span>
        <span class="c1"># In case they get put on another device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_map</span> <span class="o">=</span> <span class="n">attenuation_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_splits</span> <span class="o">=</span> <span class="n">N_splits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_sens_factor</span><span class="p">()</span>
        
<div class="viewcode-block" id="PETLMSystemMatrix.set_n_subsets"><a class="viewcode-back" href="../../../../autoapi/pytomography/projectors/PET/petlm_system_matrix/index.html#pytomography.projectors.PET.PETLMSystemMatrix.set_n_subsets">[docs]</a>    <span class="k">def</span> <span class="nf">set_n_subsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list where each element consists of an array of indices corresponding to a partitioned version of the projections. </span>

<span class="sd">        Args:</span>
<span class="sd">            n_subsets (int): Number of subsets to partition the projections into</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of arrays where each array corresponds to the projection indices of a particular subset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_device</span><span class="p">)</span>
        <span class="n">subset_indices_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_subsets</span><span class="p">):</span>
            <span class="n">subset_indices_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">n_subsets</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subset_indices_array</span> <span class="o">=</span> <span class="n">subset_indices_array</span></div>
        
<div class="viewcode-block" id="PETLMSystemMatrix.get_projection_subset"><a class="viewcode-back" href="../../../../autoapi/pytomography/projectors/PET/petlm_system_matrix/index.html#pytomography.projectors.PET.PETLMSystemMatrix.get_projection_subset">[docs]</a>    <span class="k">def</span> <span class="nf">get_projection_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projections</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">subset_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtains subsampled projections :math:`g_m` corresponding to subset index :math:`m`. For LM PET, its always the case that :math:`g_m=1`, but this function is still required for subsampling scatter :math:`s_m` as is required in certain reconstruction algorithms</span>

<span class="sd">        Args:</span>
<span class="sd">            projections (torch.Tensor): total projections :math:`g`</span>
<span class="sd">            subset_idx (int): subset index :math:`m`</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: subsampled projections :math:`g_m`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Needs to consider cases where projection is simply a 1 element tensor in the numerator, but also cases of scatter where it is a longer tensor</span>
        <span class="n">subset_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset_indices_array</span><span class="p">[</span><span class="n">subset_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">projections</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">subset_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">proj_subset</span> <span class="o">=</span> <span class="n">projections</span><span class="p">[</span><span class="n">subset_indices</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proj_subset</span> <span class="o">=</span> <span class="n">projections</span>
        <span class="k">return</span> <span class="n">proj_subset</span></div>
    
<div class="viewcode-block" id="PETLMSystemMatrix.get_weighting_subset"><a class="viewcode-back" href="../../../../autoapi/pytomography/projectors/PET/petlm_system_matrix/index.html#pytomography.projectors.PET.PETLMSystemMatrix.get_weighting_subset">[docs]</a>    <span class="k">def</span> <span class="nf">get_weighting_subset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subset_idx</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Computes the relative weighting of a given subset (given that the projection space is reduced). This is used for scaling parameters relative to :math:`\tilde{H}_m^T 1` in reconstruction algorithms, such as prior weighting :math:`\beta`</span>

<span class="sd">        Args:</span>
<span class="sd">            subset_idx (int): Subset index</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Weighting for the subset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subset_indices_array</span><span class="p">[</span><span class="n">subset_idx</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="PETLMSystemMatrix.compute_atteunation_probability_projection"><a class="viewcode-back" href="../../../../autoapi/pytomography/projectors/PET/petlm_system_matrix/index.html#pytomography.projectors.PET.PETLMSystemMatrix.compute_atteunation_probability_projection">[docs]</a>    <span class="k">def</span> <span class="nf">compute_atteunation_probability_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes probabilities of photons being detected along an LORs corresponding to ``idx``.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx (torch.tensor): Indices of the detector pairs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The probabilities of photons being detected along the detector pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx_partial</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor_split</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_splits</span><span class="p">):</span>
            <span class="n">proj_i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">parallelproj</span><span class="o">.</span><span class="n">joseph3d_fwd</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">object_origin</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">object_meta</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span>
                <span class="n">num_chunks</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">proj</span><span class="p">,</span> <span class="n">proj_i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">proj</span></div>
        
<div class="viewcode-block" id="PETLMSystemMatrix.compute_sens_factor"><a class="viewcode-back" href="../../../../autoapi/pytomography/projectors/PET/petlm_system_matrix/index.html#pytomography.projectors.PET.PETLMSystemMatrix.compute_sens_factor">[docs]</a>    <span class="k">def</span> <span class="nf">compute_sens_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_splits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Computes the normalization factor :math:`\tilde{H}^T w` where :math:`w` is the weighting specified in the projection metadata that accounts for attenuation/normalization correction.</span>

<span class="sd">        Args:</span>
<span class="sd">            N_splits (int, optional): Optionally splits up computation to save memory on GPU. Defaults to 10.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load all detector ids used to compute sensitivity image</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids_sensitivity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">detector_ids_sensitivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids_sensitivity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">detector_ids_sensitivity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">weights_sensitivity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights_sensitivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">weights_sensitivity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights_sensitivity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">detector_ids_sensitivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="c1"># Scale the weights by attenuation image if its provided in the system matrix</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights_sensitivity</span> <span class="o">=</span> <span class="n">weights_sensitivity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_atteunation_probability_projection</span><span class="p">(</span><span class="n">detector_ids_sensitivity</span><span class="p">)</span>
        <span class="c1"># Compute norm image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_BP</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">weight_subset</span><span class="p">,</span> <span class="n">detector_ids_sensitivity_subset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor_split</span><span class="p">(</span><span class="n">weights_sensitivity</span><span class="p">,</span> <span class="n">N_splits</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor_split</span><span class="p">(</span><span class="n">detector_ids_sensitivity</span><span class="p">,</span> <span class="n">N_splits</span><span class="p">)):</span>
            <span class="c1"># Add tensors to PyTomography device for fast projection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">norm_BP</span> <span class="o">+=</span> <span class="n">parallelproj</span><span class="o">.</span><span class="n">joseph3d_back</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">detector_ids_sensitivity_subset</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">detector_ids_sensitivity_subset</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">object_meta</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">object_origin</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">object_meta</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span>
                <span class="n">weight_subset</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="n">pytomography</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span>
                <span class="n">num_chunks</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Apply object transforms</span>
        <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj2obj_transforms</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">norm_BP</span>  <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_BP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_BP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_BP</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span></div>

<div class="viewcode-block" id="PETLMSystemMatrix.compute_normalization_factor"><a class="viewcode-back" href="../../../../autoapi/pytomography/projectors/PET/petlm_system_matrix/index.html#pytomography.projectors.PET.PETLMSystemMatrix.compute_normalization_factor">[docs]</a>    <span class="k">def</span> <span class="nf">compute_normalization_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function called by reconstruction algorithms to get the sensitivty image :math:`\tilde{H}_m^T w`.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset_idx (int | None, optional): Subset index :math:`m`. If none, then considers backprojection over all subsets. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.tensor: Normalization factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">subset_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fraction_considered</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fraction_considered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset_indices_array</span><span class="p">[</span><span class="n">subset_idx</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="k">return</span> <span class="n">fraction_considered</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_BP</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_device</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PETLMSystemMatrix.forward"><a class="viewcode-back" href="../../../../autoapi/pytomography/projectors/PET/petlm_system_matrix/index.html#pytomography.projectors.PET.PETLMSystemMatrix.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">object</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span>
        <span class="n">subset_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes forward projection. In the case of list mode PET, this corresponds to the expected number of detected counts along each LOR corresponding to a particular object.</span>

<span class="sd">        Args:</span>
<span class="sd">            object (torch.tensor): Object to be forward projected</span>
<span class="sd">            subset_idx (int, optional): Subset index :math:`m` of the projection. If None, then assumes projection to the entire projection space. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.tensor: Projections corresponding to the expected number of counts along each LOR.</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="c1"># Deal With subset stuff</span>
        <span class="k">if</span> <span class="n">subset_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subset_indices_array</span><span class="p">[</span><span class="n">subset_idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="c1"># Apply object space transforms</span>
        <span class="nb">object</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj2obj_transforms</span><span class="p">:</span>
            <span class="nb">object</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
        <span class="c1"># Project</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx_partial</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor_split</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_splits</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOF</span><span class="p">:</span>
                <span class="n">proj_i</span> <span class="o">=</span> <span class="n">parallelproj</span><span class="o">.</span><span class="n">joseph3d_fwd_tof_lm</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                    <span class="nb">object</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">object_origin</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">object_meta</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">tof_meta</span><span class="o">.</span><span class="n">bin_width</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">tof_meta</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">tof_meta</span><span class="o">.</span><span class="n">center_offset</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">tof_meta</span><span class="o">.</span><span class="n">n_sigmas</span><span class="p">,</span>
                    <span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">tof_meta</span><span class="o">.</span><span class="n">num_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proj_i</span> <span class="o">=</span> <span class="n">parallelproj</span><span class="o">.</span><span class="n">joseph3d_fwd</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                    <span class="nb">object</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">object_origin</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">object_meta</span><span class="o">.</span><span class="n">dr</span>
                    <span class="p">)</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">proj</span><span class="p">,</span> <span class="n">proj_i</span><span class="o">.</span><span class="n">cpu</span><span class="p">()])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">proj</span><span class="o">*=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_projection_subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">subset_idx</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">proj</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_device</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="PETLMSystemMatrix.backward"><a class="viewcode-back" href="../../../../autoapi/pytomography/projectors/PET/petlm_system_matrix/index.html#pytomography.projectors.PET.PETLMSystemMatrix.backward">[docs]</a>    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">proj</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span>
        <span class="n">subset_idx</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_norm_constant</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes back projection. This corresponds to tracing a sequence of LORs into object space.</span>

<span class="sd">        Args:</span>
<span class="sd">            proj (torch.tensor): Projections to be back projected</span>
<span class="sd">            subset_idx (int, optional): Subset index :math:`m` of the projection. If None, then assumes projection to the entire projection space. Defaults to None.</span>
<span class="sd">            return_norm_constant (bool, optional): Whether or not to return the normalization constant: useful in reconstruction algorithms that require :math:`H_m^T 1`. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.tensor: _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Deal With subset stuff</span>
        <span class="k">if</span> <span class="n">subset_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subset_indices_array</span><span class="p">[</span><span class="n">subset_idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">detector_ids</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">BP</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">proj</span><span class="o">*=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_projection_subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">subset_idx</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">proj_i</span><span class="p">,</span> <span class="n">idx_partial</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor_split</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_splits</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor_split</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_splits</span><span class="p">)):</span>
            <span class="n">proj_i</span> <span class="o">=</span> <span class="n">proj_i</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOF</span><span class="p">:</span>
                <span class="n">BP</span> <span class="o">+=</span> <span class="n">parallelproj</span><span class="o">.</span><span class="n">joseph3d_back_tof_lm</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">object_meta</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">object_origin</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">object_meta</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span>
                    <span class="n">proj_i</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">tof_meta</span><span class="o">.</span><span class="n">bin_width</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">tof_meta</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">tof_meta</span><span class="o">.</span><span class="n">center_offset</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">tof_meta</span><span class="o">.</span><span class="n">n_sigmas</span><span class="p">,</span>
                    <span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">tof_meta</span><span class="o">.</span><span class="n">num_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">BP</span> <span class="o">+=</span> <span class="n">parallelproj</span><span class="o">.</span><span class="n">joseph3d_back</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proj_meta</span><span class="o">.</span><span class="n">scanner_lut</span><span class="p">[</span><span class="n">idx_partial</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pytomography</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">object_meta</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">object_origin</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">object_meta</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span>
                    <span class="n">proj_i</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Apply object transforms</span>
        <span class="n">norm_constant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_normalization_factor</span><span class="p">(</span><span class="n">subset_idx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj2obj_transforms</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">return_norm_constant</span><span class="p">:</span>
                <span class="n">BP</span><span class="p">,</span> <span class="n">norm_constant</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">BP</span><span class="p">,</span> <span class="n">norm_constant</span><span class="o">=</span><span class="n">norm_constant</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">BP</span>  <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">BP</span><span class="p">)</span>
        <span class="c1"># Return</span>
        <span class="k">if</span> <span class="n">return_norm_constant</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BP</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_device</span><span class="p">),</span> <span class="n">norm_constant</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BP</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_device</span><span class="p">)</span></div></div>
</pre></div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2023, Luke Polson.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.2.1.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>