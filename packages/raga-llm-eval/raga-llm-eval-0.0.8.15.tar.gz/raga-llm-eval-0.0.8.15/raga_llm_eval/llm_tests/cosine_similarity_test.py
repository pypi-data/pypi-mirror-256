"""
Cosine Similarity Test
"""

import whylogs as why
from whylogs.experimental.core.udf_schema import udf_schema

text_schema = udf_schema()


def cosine_similarity_test(prompt, response, threshold=0.5):
    """
    Provides the cosine similarity score.

    Args:
        prompt (str): the prompt given to the model
        response (str): the response generated by the model
        threshold (float, optional): The threshold for readability score (default is 0.5).

    Returns:
        dict: A dictionary containing the prompt, response, cosine similarity score,
              is_passed, and threshold.
    """
    profile = why.log(
        {"prompt": prompt, "response": response}, schema=text_schema
    ).profile()

    similarity_score = (
        profile.view()
        .get_column("response.relevance_to_prompt")
        .get_metric("distribution")
        .to_summary_dict()["mean"]
    )

    is_similar = "Passed" if (similarity_score > threshold) else "Failed"

    result = {
        "prompt": prompt,
        "response": response,
        "score": similarity_score,
        "is_passed": is_similar,
        "threshold": threshold,
    }
    return result
